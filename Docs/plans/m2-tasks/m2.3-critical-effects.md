---
title: "M2.3 크리티컬 & 연출"
type: feat
date: 2026-01-27
milestone: M2
task_id: M2.3
depends_on: [M2.0]
scripts: 4
---

# M2.3: 크리티컬 & 연출

## 목표

크리티컬 시스템과 특별 이벤트 연출을 구현합니다.
강력한 타격의 만족감과 진행 보상의 시각적 피드백을 제공합니다.

## 의존성

- **M2.0**: 오디오 시스템 필수 (크리티컬 사운드)

## 구현할 스크립트

### 1. CriticalSystem.cs

```
Assets/02.Scripts/Combat/CriticalSystem.cs
```

**역할:** 크리티컬 확률 및 배율 관리

**주요 기능:**
- 크리티컬 확률 계산
- 크리티컬 배율 적용
- 업그레이드 연동 (확률/배율 증가)
- 통계 추적

**인터페이스:**
```csharp
public class CriticalSystem : MonoBehaviour
{
    // 기본 값
    [SerializeField] private float _baseCritChance = 0.05f;  // 5%
    [SerializeField] private float _baseCritMultiplier = 2f;  // 2배

    // 보너스 (업그레이드에서 추가)
    public float BonusCritChance { get; set; }
    public float BonusCritMultiplier { get; set; }

    // 계산
    public float TotalCritChance => _baseCritChance + BonusCritChance;
    public float TotalCritMultiplier => _baseCritMultiplier + BonusCritMultiplier;

    // 판정
    public CritResult CalculateDamage(long baseDamage)
    {
        bool isCrit = Random.value < TotalCritChance;
        long finalDamage = isCrit ? (long)(baseDamage * TotalCritMultiplier) : baseDamage;
        return new CritResult(isCrit, finalDamage);
    }

    // 이벤트
    public event Action<long> OnCriticalHit;
}

public struct CritResult
{
    public bool IsCritical;
    public long Damage;
}
```

### 2. CriticalEffect.cs

```
Assets/02.Scripts/Effects/CriticalEffect.cs
```

**역할:** 크리티컬 시각/청각 연출

**주요 기능:**
- 번개 이펙트 (전기 파티클)
- 화면 플래시 (흰색/노란색)
- 강화된 화면 흔들림
- 크리티컬 사운드 재생
- 특수 플로팅 텍스트

**인터페이스:**
```csharp
public class CriticalEffect : MonoBehaviour
{
    [Header("Visual")]
    [SerializeField] private ParticleSystem _lightningEffect;
    [SerializeField] private float _flashDuration = 0.1f;
    [SerializeField] private Color _flashColor = Color.yellow;

    [Header("Camera")]
    [SerializeField] private float _shakeIntensity = 0.5f;
    [SerializeField] private float _shakeDuration = 0.2f;

    [Header("Audio")]
    [SerializeField] private string _criticalSFXId = "hit_critical";

    public void PlayCriticalEffect(Vector3 hitPosition, long damage);
}
```

**연출 시퀀스:**
1. 번개 파티클 발생 (타격 위치)
2. 화면 플래시 (0.05초)
3. 강한 화면 흔들림 (0.2초)
4. 크리티컬 사운드 재생
5. 크리티컬 스타일 플로팅 텍스트

### 3. EvolutionEffect.cs

```
Assets/02.Scripts/Effects/EvolutionEffect.cs
```

**역할:** 진화/레벨업 연출

**주요 기능:**
- 화면 전체 연출
- 축하 파티클
- 토스트 메시지
- 카메라 줌 효과

**인터페이스:**
```csharp
public class EvolutionEffect : MonoBehaviour
{
    [SerializeField] private ParticleSystem _celebrationParticle;
    [SerializeField] private float _zoomDuration = 1f;
    [SerializeField] private float _zoomAmount = 0.9f;

    public void PlayTreeEvolution(int evolutionLevel);
    public void PlayBackgroundEvolution(int evolutionLevel);
    public void PlayAxeEvolution(int evolutionLevel);
}
```

**연출 시퀀스 (나무 진화):**
1. 게임 일시 정지 (0.5초)
2. 카메라 줌 인 (나무 포커스)
3. 화이트 플래시
4. 나무 변신 (스케일 애니메이션)
5. 축하 파티클
6. 축하 메시지 토스트
7. 카메라 줌 아웃
8. 게임 재개

### 4. LevelUpEffect.cs

```
Assets/02.Scripts/Effects/LevelUpEffect.cs
```

**역할:** 업그레이드 구매 시 연출

**주요 기능:**
- 업그레이드 아이콘 연출
- 레벨업 파티클
- 능력치 상승 표시

**인터페이스:**
```csharp
public class LevelUpEffect : MonoBehaviour
{
    public void PlayUpgradeEffect(UpgradeData upgrade, int newLevel);
    public void PlayStatIncreaseEffect(string statName, string value);
}
```

**연출:**
1. 업그레이드 아이콘 팝업
2. 레벨 숫자 애니메이션
3. "+1 클릭 파워" 같은 능력치 표시
4. 파티클 효과

## 기존 코드 수정

### InputHandler.cs 수정

```csharp
private void HandleClick(Vector3 hitPoint)
{
    var gameManager = ServiceLocator.Get<GameManager>();
    var critSystem = ServiceLocator.Get<CriticalSystem>();

    long baseDamage = gameManager.GetClickPower();
    var result = critSystem.CalculateDamage(baseDamage);

    // 나무에 데미지 적용
    _treeController.Hit(result.Damage, hitPoint);

    // 크리티컬 연출
    if (result.IsCritical)
    {
        var critEffect = ServiceLocator.Get<CriticalEffect>();
        critEffect?.PlayCriticalEffect(hitPoint, result.Damage);
    }
}
```

### TreeController.cs 수정

```csharp
// Hit 메서드에 크리티컬 여부 전달
public void Hit(long damage, Vector3 hitPoint, bool isCritical = false)
{
    // 기존 로직...

    // 플로팅 텍스트 스타일 분기
    if (isCritical)
    {
        _floatingTextSpawner.SpawnCriticalText(hitPoint, damage);
    }
    else
    {
        _floatingTextSpawner.SpawnNormalText(hitPoint, damage);
    }
}
```

## 체크리스트

### 구현

- [ ] CriticalSystem 구현
- [ ] ServiceLocator 등록
- [ ] CriticalEffect 구현
- [ ] EvolutionEffect 구현
- [ ] LevelUpEffect 구현

### 연출

- [ ] 번개 파티클 생성
- [ ] 화면 플래시 구현
- [ ] 강화된 화면 흔들림
- [ ] 진화 시퀀스 구현
- [ ] 레벨업 UI 연출

### 연동

- [ ] InputHandler에 크리티컬 시스템 연동
- [ ] 크리티컬 사운드 연동
- [ ] 플로팅 텍스트 스타일 연동
- [ ] 업그레이드 구매 연출 연동

### 테스트

- [ ] 크리티컬 확률 정확도 확인
- [ ] 연출 타이밍 자연스러움
- [ ] 성능 테스트 (연속 크리티컬)
- [ ] 진화 연출 완성도

## 크리티컬 밸런스

### 초기 값

| 항목 | 값 | 비고 |
|------|-----|------|
| 기본 확률 | 5% | 20회 중 1회 |
| 기본 배율 | 2x | 2배 데미지 |

### 업그레이드 보너스 (M3에서 구현)

| 업그레이드 | 효과 |
|------------|------|
| 날카로운 눈 | +1% 크리티컬 확률/레벨 |
| 파괴의 일격 | +0.2x 크리티컬 배율/레벨 |

## 폴더 구조

```
Assets/
├── 02.Scripts/
│   ├── Combat/
│   │   └── CriticalSystem.cs
│   └── Effects/
│       ├── CriticalEffect.cs
│       ├── EvolutionEffect.cs
│       └── LevelUpEffect.cs
└── Prefabs/
    └── Effects/
        ├── LightningEffect.prefab
        ├── CelebrationParticle.prefab
        └── LevelUpPopup.prefab
```

## 다음 단계

M2.3 완료 후:
→ M2.4 통합 테스트에서 전체 게임 필 검증
→ M3에서 크리티컬 업그레이드 추가

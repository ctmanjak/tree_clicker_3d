---
title: "M1.5 업그레이드 시스템"
type: feat
date: 2026-01-26
milestone: M1
task_id: M1.5
depends_on: [M1.1]
scripts: 3
---

# M1.5: 업그레이드 시스템

## 목표

목재를 소비하여 클릭당 획득량을 증가시키는 업그레이드 시스템을 구현합니다.

## 의존성

- **M1.0**: ServiceLocator, ISaveable, GameEvents
- **M1.1**: GameManager (SpendWood, IncreaseWoodPerClick)

## 작업 내용

### 1. UpgradeData.cs (ScriptableObject)

**파일:** `Assets/02.Scripts/Economy/UpgradeData.cs`

```csharp
using UnityEngine;

/// <summary>
/// 업그레이드 데이터 정의
/// ScriptableObject로 에디터에서 쉽게 설정
/// </summary>
[CreateAssetMenu(fileName = "Upgrade", menuName = "LumberTycoon/Upgrade")]
public class UpgradeData : ScriptableObject
{
    [Header("기본 정보")]
    public string upgradeName;
    [TextArea] public string description;
    public Sprite icon;

    [Header("비용")]
    public long baseCost = 100;
    public float costMultiplier = 1.15f;

    [Header("효과")]
    public long effectAmount = 1;

    /// <summary>
    /// 현재 레벨에서의 비용 계산
    /// </summary>
    public long GetCost(int currentLevel)
    {
        return (long)(baseCost * Mathf.Pow(costMultiplier, currentLevel));
    }
}
```

### 2. UpgradeManager.cs

**파일:** `Assets/02.Scripts/Economy/UpgradeManager.cs`

```csharp
using System.Collections.Generic;
using UnityEngine;

/// <summary>
/// 업그레이드 관리자
/// ISaveable 구현으로 M2 저장 시스템 대비
/// </summary>
public class UpgradeManager : MonoBehaviour, ISaveable
{
    [SerializeField] private UpgradeData sharpAxeUpgrade;

    private Dictionary<string, int> upgradeLevels = new();
    private GameManager gameManager;
    private GameEvents gameEvents;

    public string SaveKey => "UpgradeManager";

    private void Awake()
    {
        ServiceLocator.Register(this);
    }

    private void Start()
    {
        gameManager = GameManager.Instance;
        gameEvents = GameEvents.Instance;
    }

    /// <summary>
    /// 업그레이드 구매 시도
    /// </summary>
    public bool TryPurchase(UpgradeData upgrade)
    {
        int currentLevel = GetLevel(upgrade);
        long cost = upgrade.GetCost(currentLevel);

        if (gameManager.SpendWood(cost))
        {
            upgradeLevels[upgrade.upgradeName] = currentLevel + 1;
            ApplyEffect(upgrade);
            gameEvents?.RaiseUpgradePurchased(upgrade.upgradeName, currentLevel + 1);
            return true;
        }
        return false;
    }

    private void ApplyEffect(UpgradeData upgrade)
    {
        gameManager.IncreaseWoodPerClick(upgrade.effectAmount);
    }

    public int GetLevel(UpgradeData upgrade)
    {
        return upgradeLevels.TryGetValue(upgrade.upgradeName, out int level) ? level : 0;
    }

    // ISaveable 구현
    public object CaptureState()
    {
        return new Dictionary<string, int>(upgradeLevels);
    }

    public void RestoreState(object state)
    {
        if (state is Dictionary<string, int> savedLevels)
        {
            upgradeLevels = new Dictionary<string, int>(savedLevels);
        }
    }
}
```

### 3. UpgradeButtonUI.cs

**파일:** `Assets/02.Scripts/UI/UpgradeButtonUI.cs`

```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

/// <summary>
/// 업그레이드 버튼 UI
/// Inspector 참조 사용 (FindObjectOfType 제거)
/// </summary>
public class UpgradeButtonUI : MonoBehaviour
{
    [Header("Data")]
    [SerializeField] private UpgradeData upgradeData;

    [Header("References")]
    [SerializeField] private UpgradeManager upgradeManager;
    [SerializeField] private Button button;
    [SerializeField] private Image iconImage;
    [SerializeField] private TextMeshProUGUI nameText;
    [SerializeField] private TextMeshProUGUI costText;
    [SerializeField] private TextMeshProUGUI levelText;
    [SerializeField] private TextMeshProUGUI effectText;

    private GameManager gameManager;

    private void Start()
    {
        gameManager = GameManager.Instance;

        // UpgradeManager가 Inspector에서 설정 안된 경우 ServiceLocator 사용
        if (upgradeManager == null)
        {
            ServiceLocator.TryGet(out upgradeManager);
        }

        button.onClick.AddListener(OnClick);
        GameEvents.Instance.OnWoodChanged += OnWoodChanged;
        UpdateDisplay();
    }

    private void OnDestroy()
    {
        if (GameEvents.Instance != null)
        {
            GameEvents.Instance.OnWoodChanged -= OnWoodChanged;
        }
    }

    private void OnClick()
    {
        if (upgradeManager.TryPurchase(upgradeData))
        {
            UpdateDisplay();
            // TODO: 구매 성공 효과음/이펙트
        }
    }

    private void OnWoodChanged(long _)
    {
        UpdateButtonState();
    }

    private void UpdateDisplay()
    {
        int level = upgradeManager.GetLevel(upgradeData);
        long cost = upgradeData.GetCost(level);

        if (iconImage != null && upgradeData.icon != null)
        {
            iconImage.sprite = upgradeData.icon;
        }

        nameText.text = upgradeData.upgradeName;
        costText.text = $"비용: {FormatNumber(cost)}";
        levelText.text = $"Lv.{level}";

        if (effectText != null)
        {
            effectText.text = $"+{upgradeData.effectAmount}/클릭";
        }

        UpdateButtonState();
    }

    private void UpdateButtonState()
    {
        int level = upgradeManager.GetLevel(upgradeData);
        long cost = upgradeData.GetCost(level);
        button.interactable = gameManager.CurrentWood >= cost;
    }

    private string FormatNumber(long num)
    {
        if (num >= 1_000_000) return $"{num / 1_000_000f:F1}M";
        if (num >= 1_000) return $"{num / 1_000f:F1}K";
        return num.ToString();
    }
}
```

## 에셋 설정

### SharpAxe 업그레이드 생성

1. **ScriptableObject 생성:**
   - Project 창에서 우클릭 > Create > LumberTycoon > Upgrade
   - 이름: SharpAxe

2. **SharpAxe 설정:**
   ```
   upgradeName: "날카로운 도끼"
   description: "도끼를 갈아 더 많은 목재를 획득합니다."
   baseCost: 100
   costMultiplier: 1.15
   effectAmount: 1
   ```

3. **저장 위치:**
   - Assets/Resources/Upgrades/SharpAxe.asset

## 씬 설정

### UpgradeManager 추가

1. **UpgradeManager 오브젝트:**
   - Empty GameObject "UpgradeManager" 생성
   - UpgradeManager.cs 추가
   - --- MANAGERS --- 하위에 배치

### 업그레이드 버튼 UI

1. **UI 구조:**
   ```
   Canvas
   └── UpgradePanel (Panel)
       └── SharpAxeButton (Button)
           ├── Icon (Image)
           ├── NameText (TextMeshPro)
           ├── CostText (TextMeshPro)
           ├── LevelText (TextMeshPro)
           └── EffectText (TextMeshPro)
   ```

2. **UpgradePanel 설정:**
   - Anchor: Bottom Center
   - Position: (0, 100, 0)
   - Size: (300, 100)

3. **SharpAxeButton 설정:**
   - UpgradeButtonUI.cs 추가
   - upgradeData: SharpAxe 에셋 연결
   - upgradeManager: UpgradeManager 연결
   - 각 Text 필드 연결

## Acceptance Criteria

- [ ] UpgradeData.cs 컴파일 성공
- [ ] UpgradeManager.cs 컴파일 성공
- [ ] UpgradeButtonUI.cs 컴파일 성공
- [ ] SharpAxe 에셋 생성 완료
- [ ] 업그레이드 버튼 클릭 시 목재 100 차감
- [ ] 업그레이드 후 클릭당 획득량 +1 증가
- [ ] 레벨 표시 업데이트 (Lv.0 → Lv.1)
- [ ] 비용 표시 업데이트 (100 → 115)
- [ ] 목재 부족 시 버튼 비활성화

## 테스트 방법

1. Play 모드 시작
2. 나무 100번 클릭하여 목재 100 수집
3. 업그레이드 버튼 클릭
4. 목재가 0으로 감소하는지 확인
5. 버튼에 "Lv.1", "비용: 115" 표시 확인
6. 나무 클릭 시 +2 목재 획득 확인

## 다음 태스크

→ M1.7 통합 테스트 (M1.3, M1.4, M1.6 완료 후)

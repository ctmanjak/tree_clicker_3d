---
title: "M1.6 벌목꾼 시스템"
type: feat
date: 2026-01-26
milestone: M1
task_id: M1.6
depends_on: [M1.1]
scripts: 2
---

# M1.6: 벌목꾼 시스템

## 목표

자동으로 나무를 베어 목재를 수집하는 벌목꾼 AI를 구현합니다.

## 의존성

- **M1.1**: GameManager.AddWood

## 작업 내용

### 1. LumberjackController.cs

**파일:** `Assets/02.Scripts/Lumberjack/LumberjackController.cs`

```csharp
using UnityEngine;

/// <summary>
/// 벌목꾼 AI 컨트롤러
/// 나무 주변 이동 → 타격 → 목재 수집 반복
/// </summary>
public class LumberjackController : MonoBehaviour
{
    [Header("Stats")]
    [SerializeField] private float woodPerSecond = 1f;
    [SerializeField] private float moveSpeed = 2f;
    [SerializeField] private float attackInterval = 1f;
    [SerializeField] private float attackRange = 2f;

    [Header("References")]
    [SerializeField] private Transform treeTarget;

    private enum State { Idle, Moving, Attacking }
    private State currentState = State.Idle;

    private float attackTimer;
    private float woodAccumulator;
    private Vector3 targetPosition;
    private GameManager gameManager;

    private void Start()
    {
        gameManager = GameManager.Instance;
        FindTree();
    }

    private void Update()
    {
        switch (currentState)
        {
            case State.Idle:
                FindTree();
                break;
            case State.Moving:
                MoveToTree();
                break;
            case State.Attacking:
                Attack();
                break;
        }
    }

    private void FindTree()
    {
        if (treeTarget == null)
        {
            GameObject treeObj = GameObject.FindWithTag("Tree");
            if (treeObj != null)
            {
                treeTarget = treeObj.transform;
            }
        }

        if (treeTarget != null)
        {
            // 나무 주변 랜덤 위치 선정
            targetPosition = treeTarget.position + GetRandomOffset();
            currentState = State.Moving;
        }
    }

    private void MoveToTree()
    {
        if (treeTarget == null)
        {
            currentState = State.Idle;
            return;
        }

        Vector3 direction = (targetPosition - transform.position);
        direction.y = 0; // 수평 이동만

        if (direction.magnitude < 0.1f)
        {
            // 목표 도착
            currentState = State.Attacking;
            LookAtTree();
            return;
        }

        // 이동
        transform.position += direction.normalized * moveSpeed * Time.deltaTime;

        // 이동 방향으로 회전
        if (direction.magnitude > 0.1f)
        {
            transform.rotation = Quaternion.LookRotation(direction.normalized);
        }
    }

    private void Attack()
    {
        if (treeTarget == null)
        {
            currentState = State.Idle;
            return;
        }

        attackTimer += Time.deltaTime;

        if (attackTimer >= attackInterval)
        {
            attackTimer = 0;

            // 목재 수집 (소수점 누적 후 정수 단위로 추가)
            woodAccumulator += woodPerSecond * attackInterval;

            if (woodAccumulator >= 1f)
            {
                long woodToAdd = (long)woodAccumulator;
                gameManager.AddWood(woodToAdd);
                woodAccumulator -= woodToAdd;
            }

            // 타격 애니메이션/이펙트 (M3에서 추가)
            OnAttack();
        }
    }

    private void OnAttack()
    {
        // TODO: 타격 애니메이션 트리거
        // TODO: 타격 효과음
        // TODO: 작은 파티클 효과
    }

    private void LookAtTree()
    {
        if (treeTarget != null)
        {
            Vector3 lookDir = (treeTarget.position - transform.position);
            lookDir.y = 0;
            if (lookDir.magnitude > 0.1f)
            {
                transform.rotation = Quaternion.LookRotation(lookDir);
            }
        }
    }

    private Vector3 GetRandomOffset()
    {
        float angle = Random.Range(0f, 360f) * Mathf.Deg2Rad;
        float distance = Random.Range(attackRange * 0.8f, attackRange);
        return new Vector3(Mathf.Cos(angle) * distance, 0, Mathf.Sin(angle) * distance);
    }

    /// <summary>
    /// 외부에서 스탯 설정 (업그레이드 시 사용)
    /// </summary>
    public void SetStats(float wps, float speed)
    {
        woodPerSecond = wps;
        moveSpeed = speed;
    }
}
```

### 2. LumberjackSpawner.cs

**파일:** `Assets/02.Scripts/Lumberjack/LumberjackSpawner.cs`

```csharp
using UnityEngine;
using System.Collections.Generic;

/// <summary>
/// 벌목꾼 스폰 관리
/// </summary>
public class LumberjackSpawner : MonoBehaviour
{
    [SerializeField] private GameObject lumberjackPrefab;
    [SerializeField] private Transform spawnPoint;
    [SerializeField] private int maxLumberjacks = 20;

    private List<LumberjackController> activeLumberjacks = new();

    public int ActiveCount => activeLumberjacks.Count;
    public bool CanSpawn => activeLumberjacks.Count < maxLumberjacks;

    /// <summary>
    /// 벌목꾼 스폰
    /// </summary>
    public LumberjackController SpawnLumberjack()
    {
        if (!CanSpawn)
        {
            Debug.LogWarning("Maximum lumberjacks reached!");
            return null;
        }

        Vector3 spawnPos = spawnPoint != null ? spawnPoint.position : GetRandomSpawnPosition();
        GameObject obj = Instantiate(lumberjackPrefab, spawnPos, Quaternion.identity);

        var controller = obj.GetComponent<LumberjackController>();
        if (controller != null)
        {
            activeLumberjacks.Add(controller);
        }

        return controller;
    }

    private Vector3 GetRandomSpawnPosition()
    {
        // 화면 가장자리에서 스폰
        float angle = Random.Range(0f, 360f) * Mathf.Deg2Rad;
        float distance = 10f;
        return new Vector3(Mathf.Cos(angle) * distance, 0, Mathf.Sin(angle) * distance);
    }

    /// <summary>
    /// 특정 벌목꾼 제거
    /// </summary>
    public void RemoveLumberjack(LumberjackController lumberjack)
    {
        if (activeLumberjacks.Contains(lumberjack))
        {
            activeLumberjacks.Remove(lumberjack);
            Destroy(lumberjack.gameObject);
        }
    }

    /// <summary>
    /// 모든 벌목꾼 제거
    /// </summary>
    public void ClearAll()
    {
        foreach (var lumberjack in activeLumberjacks)
        {
            if (lumberjack != null)
            {
                Destroy(lumberjack.gameObject);
            }
        }
        activeLumberjacks.Clear();
    }
}
```

## 프리팹 설정

### Lumberjack 프리팹

1. **임시 모델 (M1용):**
   ```
   Lumberjack (Empty)
   └── Visual (Capsule)
       - Scale: (0.5, 1, 0.5)
       - Material: Green
   ```

2. **컴포넌트:**
   - LumberjackController.cs 추가
   - Rigidbody (선택, M3에서 충돌 처리 시)

3. **기본 스탯:**
   ```
   woodPerSecond: 1
   moveSpeed: 2
   attackInterval: 1
   attackRange: 2
   ```

4. **저장 위치:**
   - Assets/03.Prefabs/Lumberjack.prefab

## 씬 설정

### LumberjackSpawner 추가

1. **LumberjackSpawner 오브젝트:**
   - Empty GameObject "LumberjackSpawner" 생성
   - LumberjackSpawner.cs 추가
   - lumberjackPrefab: Lumberjack.prefab 연결

### 벌목꾼 소환 버튼 (임시)

M1에서는 간단한 테스트용 버튼 추가:

1. **UI 버튼:**
   ```
   Canvas
   └── SpawnLumberjackButton (Button)
       └── Text: "벌목꾼 소환"
   ```

2. **OnClick 연결:**
   - LumberjackSpawner.SpawnLumberjack() 호출

> **Note:** M2에서 업그레이드 시스템과 연동하여 벌목꾼 소환을 업그레이드로 구매하도록 변경

## Acceptance Criteria

- [ ] LumberjackController.cs 컴파일 성공
- [ ] LumberjackSpawner.cs 컴파일 성공
- [ ] Lumberjack.prefab 생성 완료
- [ ] 벌목꾼 스폰 시 나무 방향으로 이동
- [ ] 나무 근처 도착 시 정지 후 타격 상태
- [ ] 1초마다 목재 +1 획득
- [ ] WoodCounterUI에 실시간 반영

## 테스트 방법

1. Play 모드 시작
2. "벌목꾼 소환" 버튼 클릭
3. 벌목꾼이 나무 방향으로 이동하는지 확인
4. 나무 근처에서 정지하는지 확인
5. 1초마다 목재가 증가하는지 확인
6. 여러 명 스폰해도 정상 동작하는지 확인

## 다음 태스크

→ M1.7 통합 테스트 (M1.3, M1.4, M1.5 완료 후)
